<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPE Tracker Dashboard</title>

    <script>
        
    </script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="../styles/styles.css">
    <link rel="stylesheet" href="../styles/planes.css">
    <style>
        /* Hacer que las celdas de la tabla puedan hacer wrap en pantallas pequeñas
           y evitar que el contenido fuerce un ancho mayor que la pantalla. */
        @media (max-width: 767.98px) {
            .table-responsive table td,
            .table-responsive table th {
                white-space: normal !important;
                word-break: break-word;
            }
            /* Opcional: tablas más compactas en móvil */
            .table-responsive table.table-sm td,
            .table-responsive table.table-sm th {
                padding: .3rem .4rem;
            }
        }
        /* Estilos para tarjetas móvil: evitar que los iconos se pisen
           y truncar texto largo en el lado izquierdo. */
        .atleta-card .card-body {
            padding: .75rem;
        }
        .atleta-card .card-body .card-left {
            min-width: 0; /* importante para que flex items puedan encoger */
            overflow: hidden;
        }
        .atleta-card .card-body .card-left .card-title {
            margin: 0 0 .25rem 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70vw; /* ocupa la mayor parte del ancho disponible en móvil */
        }
        .atleta-card .card-body .card-left .card-subtitle {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70vw;
        }
        .atleta-card .card-actions {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: .3rem;
            min-width: 72px; /* asegura espacio para botones */
        }
        .atleta-card .card-actions .btn {
            white-space: nowrap;
        }
        @media (min-width: 576px) {
            .atleta-card .card-body .card-left .card-title,
            .atleta-card .card-body .card-left .card-subtitle {
                max-width: 50vw;
            }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <!-- BARRA DE NAVEGACIÓN SUPERIOR -->
        <nav class="top-navbar d-flex justify-content-between align-items-center">
            
        </nav>

        <!-- Backdrop para móvil -->
        <div class="sidebar-backdrop" data-bs-toggle="collapse" data-bs-target="#sidebarMenu"></div>
        
        <!-- BARRA LATERAL -->
        <aside class="sidebar collapse d-lg-block" id="sidebarMenu">
            
        </aside>

        <!-- CONTENIDO PRINCIPAL -->
        <main class="main-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5>Atletas</h5>
                <button class="btn btn-custom-primary d-none d-lg-block" id="btnNuevoAtleta"><i class="bi bi-plus-lg me-1"></i> Nuevo Atleta</button>
            </div>

            <!-- Búsqueda y filtros -->
            <div class="mb-4">
                <input type="text" class="form-control" id="inputBuscar" placeholder="Buscar por nombre o email...">
            </div>

            <!-- Tabla de atletas (visible en md+) -->
            <div class="table-responsive d-none d-md-block">
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Estado</th>
                            <th>Fecha de Creación</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="atletasTableBody">
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">Cargando atletas...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Contenedor de tarjetas para móvil -->
            <div id="atletasCardsContainer" class="d-block d-md-none"></div>
        </main>
    </div>

        <!-- Modales de confirmación y formulario de atleta -->
        <!-- Modal de confirmación para asignar atleta -->
        <div class="modal fade" id="confirmAsignarModal" tabindex="-1" aria-labelledby="confirmAsignarModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-white text-dark">
                        <h5 class="modal-title text-dark" id="confirmAsignarModalLabel">Confirmar asignación</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body bg-white text-dark" id="confirmAsignarModalBody">
                        ¿Deseas asignar este atleta a tu cuenta?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-success" id="btnConfirmAsignar">Asignar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de confirmación para eliminar atleta -->
        <div class="modal fade" id="confirmEliminarModal" tabindex="-1" aria-labelledby="confirmEliminarModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-white text-dark">
                        <h5 class="modal-title" id="confirmEliminarModalLabel">Confirmar eliminación</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body bg-white text-dark" id="confirmEliminarModalBody">
                        ¿Estás seguro de que deseas eliminar este atleta? Esta acción no se puede deshacer.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger" id="btnConfirmEliminar">Eliminar</button>
                    </div>
                </div>
            </div>
        </div>
    <div class="modal fade" id="atletaModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="atletaModalTitle">Nuevo Atleta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="atletaForm">
                        <div class="mb-3">
                            <label for="atletaNombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="atletaNombre" placeholder="Ej: Juan" required>
                        </div>
                        <div class="mb-3">
                            <label for="atletaApellido" class="form-label">Apellido</label>
                            <input type="text" class="form-control" id="atletaApellido" placeholder="Ej: Pérez">
                        </div>
                        <div class="mb-3">
                            <label for="atletaEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="atletaEmail" placeholder="Ej: juan@mail.com" required>
                        </div>
                        <div class="mb-3">
                            <label for="atletaContrasena" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="atletaContrasena" placeholder="••••••••" required>
                            <small class="text-muted d-block mt-1">El atleta usará esto para loguearse</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardarAtleta">Guardar Atleta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Botón flotante para móvil -->
    <button class="btn btn-custom-primary d-lg-none" id="btnNuevoAtletaMobile" style="position: fixed; bottom: 2rem; right: 2rem; z-index: 50;">
        <i class="bi bi-plus-lg"></i>
    </button>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
       
    </script>
<script src="../js/estructura.js"></script>
<script src="../js/session.js"></script>

    <!-- Contenedor para Toasts (misma configuración que login) -->
    <div class="toast-container top-0 start-50 translate-middle-x" style="z-index: 1045;">
        <div id="toastNotification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Notificación</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body text-dark" id="toastMessage">
                Mensaje aquí
            </div>
        </div>
    </div>

<script>
    // ==================== VARIABLES GLOBALES ====================
    let atletaEditandoId = null;
    let usuarioLogueado = null;
    let atletasActuales = [];

    // ==================== FUNCIÓN PARA MOSTRAR TOASTS (igual que login) ====================
    /**
     * Muestra un toast de Bootstrap
     * @param {string} message - Mensaje a mostrar
     * @param {string} type - Tipo: 'success', 'error', 'warning', 'info'
     * @param {string} title - Título opcional
     */
    function showToastAtletas(message, type = 'info', title = null) {
        // Verificar que Bootstrap esté cargado
        if (typeof bootstrap === 'undefined') {
            console.error('Bootstrap no está cargado. Usando alert como fallback.');
            alert(message);
            return;
        }

        const toastEl = document.getElementById('toastNotification');
        const toastTitleEl = document.getElementById('toastTitle');
        const toastMessageEl = document.getElementById('toastMessage');

        if (!toastEl || !toastTitleEl || !toastMessageEl) {
            console.error('Elementos del toast no encontrados. Usando alert como fallback.');
            alert(message);
            return;
        }

        // Configurar título
        if (title) {
            toastTitleEl.textContent = title;
        } else {
            // Títulos por defecto según el tipo
            const titles = {
                'success': 'Éxito',
                'error': 'Error',
                'warning': 'Advertencia',
                'info': 'Información'
            };
            toastTitleEl.textContent = titles[type] || 'Notificación';
        }

        // Configurar mensaje
        toastMessageEl.textContent = message;

        // Configurar colores según el tipo
        const toastHeader = toastEl.querySelector('.toast-header');
        const toastBody = toastEl.querySelector('.toast-body');

    // Remover clases de color previas
    toastHeader.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'text-white', 'text-dark');
    toastBody.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');

    // Asegurar que el título del toast no quede en blanco por estilos heredados
    // (forzamos la clase de color correspondiente sobre el elemento del título)
    toastTitleEl.classList.remove('text-white', 'text-dark');

        // Agregar clases según el tipo
        if (type === 'success') {
            toastHeader.classList.add('bg-success', 'text-dark');
            toastBody.classList.add('bg-success', 'bg-opacity-10');
            toastTitleEl.classList.add('text-dark');
        } else if (type === 'error') {
            toastHeader.classList.add('bg-danger', 'text-white');
            toastBody.classList.add('bg-danger', 'bg-opacity-10');
            toastTitleEl.classList.add('text-white');
        } else if (type === 'warning') {
            toastHeader.classList.add('bg-warning', 'text-dark');
            toastBody.classList.add('bg-warning', 'bg-opacity-10');
            toastTitleEl.classList.add('text-dark');
        } else {
            toastHeader.classList.add('bg-info', 'text-white');
            toastBody.classList.add('bg-info', 'bg-opacity-10');
            toastTitleEl.classList.add('text-white');
        }

        // Mostrar el toast
        const toast = new bootstrap.Toast(toastEl, {
            autohide: true,
            delay: type === 'error' ? 5000 : 3000 // Errores se muestran más tiempo
        });
        toast.show();
    }

    // ==================== INICIALIZACIÓN ====================
    document.addEventListener('DOMContentLoaded', function() {
        usuarioLogueado = getCurrentUser();
        
        if (!usuarioLogueado || usuarioLogueado.userType !== 'entrenador') {
            console.error('Acceso denegado: no eres entrenador');
            window.location.href = '../index.html';
            return;
        }
        
        cargarAtletas();
        setupEventListeners();
    });

    // ==================== FUNCIONES CRUD ====================

    /**
     * Cargar y mostrar atletas del entrenador
     */
    function cargarAtletas() {
        atletasActuales = getAtletasDelEntrenador(usuarioLogueado.id);
        renderizarTabla(atletasActuales);
        renderizarTarjetas(atletasActuales);
    }

    /**
     * Renderizar tabla de atletas
     * @param {Array} atletas - Array de atletas a mostrar
     */
    function renderizarTabla(atletas) {
        const tbody = document.getElementById('atletasTableBody');
        
        if (atletas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No hay atletas registrados</td></tr>';
            return;
        }
        
        tbody.innerHTML = atletas.map(atleta => {
            const fechaCreacion = new Date(atleta.createdAt).toLocaleDateString('es-AR');
            const nombreCompleto = atleta.nombre + (atleta.apellido ? ' ' + atleta.apellido : '');
            const sinAsignar = atleta.atleta?.entrenadorId === null;
            
            return `
                <tr>
                    <td><strong>${nombreCompleto}</strong></td>
                    <td>${atleta.email}</td>
                    <td>
                        ${sinAsignar ? 
                            '<span class="badge bg-warning text-dark">Sin asignar</span>' : 
                            '<span class="badge bg-success">Asignado</span>'}
                    </td>
                    <td>${fechaCreacion}</td>
                    <td>
                        ${sinAsignar ? 
                            `<button class="btn btn-sm btn-success me-2" onclick="asignarAtleta('${atleta.id}', '${nombreCompleto}')">
                                <i class="bi bi-check-lg"></i> Asignarme
                            </button>` : 
                            ''}
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="abrirModalEditar('${atleta.id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="confirmarEliminar('${atleta.id}', '${nombreCompleto}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    /**
     * Renderizar tarjetas para vista móvil
     * @param {Array} atletas
     */
    function renderizarTarjetas(atletas) {
        const container = document.getElementById('atletasCardsContainer');
        if (!container) return;

        if (atletas.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-4">No hay atletas registrados</div>';
            return;
        }

        container.innerHTML = atletas.map(atleta => {
            const fechaCreacion = new Date(atleta.createdAt).toLocaleDateString('es-AR');
            const nombreCompleto = atleta.nombre + (atleta.apellido ? ' ' + atleta.apellido : '');
            const sinAsignar = atleta.atleta?.entrenadorId === null;

            return `
                <div class="card mb-3 atleta-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="card-left">
                                <h6 class="card-title mb-1">${nombreCompleto}</h6>
                                <p class="card-subtitle text-muted mb-1">${atleta.email}</p>
                                <div>${sinAsignar ? '<span class="badge bg-warning text-dark">Sin asignar</span>' : '<span class="badge bg-success">Asignado</span>'}</div>
                            </div>
                            <div class="card-actions">
                                ${sinAsignar ? `<button class="btn btn-sm btn-success" onclick="asignarAtleta('${atleta.id}', '${nombreCompleto}')"><i class="bi bi-check-lg"></i></button>` : ''}
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="abrirModalEditar('${atleta.id}')"><i class="bi bi-pencil"></i></button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="confirmarEliminar('${atleta.id}', '${nombreCompleto}')"><i class="bi bi-trash"></i></button>
                                </div>
                            </div>
                        </div>
                        <small class="text-muted d-block mt-2">Creado: ${fechaCreacion}</small>
                    </div>
                </div>
            `;
        }).join('');
    }

    /**
     * Abrir modal para crear nuevo atleta
     */
    function abrirModalNuevo() {
        atletaEditandoId = null;
        document.getElementById('atletaForm').reset();
        document.getElementById('atletaModalTitle').textContent = 'Nuevo Atleta';
        document.getElementById('atletaContrasena').required = true;
        new bootstrap.Modal(document.getElementById('atletaModal')).show();
    }

    /**
     * Abrir modal para editar atleta existente
     */
    function abrirModalEditar(atletaId) {
        const atleta = getAtletaById(atletaId);
        if (!atleta) {
            alert('Atleta no encontrado');
            return;
        }

        atletaEditandoId = atletaId;
    document.getElementById('atletaNombre').value = atleta.nombre;
    document.getElementById('atletaApellido').value = atleta.apellido || '';
    document.getElementById('atletaEmail').value = atleta.email;
    document.getElementById('atletaContrasena').value = atleta.password;
    document.getElementById('atletaModalTitle').textContent = 'Editar Atleta';
    document.getElementById('atletaContrasena').required = false;
    new bootstrap.Modal(document.getElementById('atletaModal')).show();
    }

    /**
     * Guardar atleta (crear o actualizar)
     */
    function guardarAtleta() {
        const nombre = document.getElementById('atletaNombre').value.trim();
        const apellido = document.getElementById('atletaApellido').value.trim();
        const email = document.getElementById('atletaEmail').value.trim();
        const contrasena = document.getElementById('atletaContrasena').value;

        if (!nombre || !email || !contrasena) {
            showToastAtletas('Completa todos los campos requeridos', 'warning');
            return;
        }

        let resultado = false;

        if (atletaEditandoId) {
            // Modo edición
            resultado = actualizarAtleta(atletaEditandoId, {
                nombre: nombre,
                apellido: apellido,
                email: email,
                password: contrasena
            });
        } else {
            // Modo creación
            resultado = crearAtletaConUsuario(nombre, email, contrasena, usuarioLogueado.id, apellido) !== null;
        }

        if (resultado) {
            showToastAtletas(
                atletaEditandoId ? 'Atleta actualizado correctamente' : 'Atleta creado exitosamente',
                'success',
                atletaEditandoId ? 'Actualización completada' : 'Atleta creado'
            );
            bootstrap.Modal.getInstance(document.getElementById('atletaModal')).hide();
            cargarAtletas();
        } else {
            showToastAtletas('Error: el email ya existe o hubo un problema', 'error');
        }
    }

    /**
     * Confirmar eliminación de atleta
     */
    function confirmarEliminar(atletaId, nombre) {
        // Abrir modal de confirmación en lugar de confirm()
        atletaEliminarId = atletaId;
        atletaEliminarNombre = nombre;
        const body = document.getElementById('confirmEliminarModalBody');
        if (body) body.textContent = `¿Estás seguro de que deseas eliminar a ${nombre}? Esta acción no se puede deshacer.`;
        const modal = new bootstrap.Modal(document.getElementById('confirmEliminarModal'));
        modal.show();
    }

    /**
     * Asignar un atleta sin entrenador al entrenador actual
     */
    // Variables temporales para asignación
    let atletaAsignarId = null;
    let atletaAsignarNombre = null;
    // Variables temporales para eliminación
    let atletaEliminarId = null;
    let atletaEliminarNombre = null;

    function asignarAtleta(atletaId, nombreAtleta) {
        atletaAsignarId = atletaId;
        atletaAsignarNombre = nombreAtleta;
        // Actualizar el texto del modal
        const body = document.getElementById('confirmAsignarModalBody');
        body.textContent = `¿Deseas asignar a ${nombreAtleta} como tu atleta?`;
        // Mostrar el modal
        const modal = new bootstrap.Modal(document.getElementById('confirmAsignarModal'));
        modal.show();
    }

    // Confirmar asignación al hacer click en el botón del modal
    document.addEventListener('DOMContentLoaded', function() {
        const btnConfirmAsignar = document.getElementById('btnConfirmAsignar');
        if (btnConfirmAsignar) {
            btnConfirmAsignar.addEventListener('click', function() {
                if (atletaAsignarId && atletaAsignarNombre) {
                    if (asignarAtletaAEntrenador(atletaAsignarId, usuarioLogueado.id)) {
                        showToastAtletas(`${atletaAsignarNombre} ha sido asignado a tu cuenta`, 'success', 'Asignación completada');
                        cargarAtletas();
                    } else {
                        showToastAtletas('Error al asignar atleta. Puede que ya tenga un entrenador asignado.', 'error');
                    }
                }
                // Cerrar el modal
                const modalEl = document.getElementById('confirmAsignarModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
                atletaAsignarId = null;
                atletaAsignarNombre = null;
            });
        }
        const btnConfirmEliminar = document.getElementById('btnConfirmEliminar');
        if (btnConfirmEliminar) {
            btnConfirmEliminar.addEventListener('click', function() {
                if (atletaEliminarId && atletaEliminarNombre) {
                    if (eliminarAtleta(atletaEliminarId)) {
                        showToastAtletas(`${atletaEliminarNombre} ha sido eliminado exitosamente`, 'success', 'Atleta eliminado');
                        cargarAtletas();
                    } else {
                        showToastAtletas('Error al eliminar atleta. Intenta de nuevo.', 'error');
                    }
                }
                // Cerrar el modal
                const modalEl = document.getElementById('confirmEliminarModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
                atletaEliminarId = null;
                atletaEliminarNombre = null;
            });
        }
    });

    /**
     * Filtrar tabla por búsqueda
     */
    function filtrarAtletas(termino) {
        const termino_lower = termino.toLowerCase();
        const filtrados = atletasActuales.filter(atleta => 
            atleta.nombre.toLowerCase().includes(termino_lower) ||
            atleta.email.toLowerCase().includes(termino_lower)
        );
        renderizarTabla(filtrados);
        // También actualizar la vista de tarjetas en móvil
        if (typeof renderizarTarjetas === 'function') {
            renderizarTarjetas(filtrados);
        }
    }

    // ==================== EVENT LISTENERS ====================
    function setupEventListeners() {
        // Botones de nuevo atleta
        document.getElementById('btnNuevoAtleta').addEventListener('click', abrirModalNuevo);
        const btnMobile = document.getElementById('btnNuevoAtletaMobile');
        if (btnMobile) {
            btnMobile.addEventListener('click', abrirModalNuevo);
        }

        // Botón guardar atleta
        document.getElementById('btnGuardarAtleta').addEventListener('click', guardarAtleta);

        // Input de búsqueda
        document.getElementById('inputBuscar').addEventListener('input', (e) => {
            filtrarAtletas(e.target.value);
        });

        // Permitir guardar con Enter en el formulario
        document.getElementById('atletaForm').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                guardarAtleta();
            }
        });
    }
</script>
</body>
</html>

